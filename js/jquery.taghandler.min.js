!function(a){function e(a,e){var t=!1;return jQuery.each(e,function(e,i){return i===a?(t=!0,!1):void 0}),t}function t(a,e){return jQuery.each(e,function(t,i){i===a&&e.splice(t,1)}),e}function i(e,i,n,o){return n.assignedTags.push(i),n.availableTags=t(i,n.availableTags),a("<li />").addClass("tagItem").text(i).insertBefore(a(e).parent()),o&&(n=s(n)),n}function n(i,n,o){var l=a(i).text();return n.assignedTags=t(l,n.assignedTags),e(l,n.originalTags)&&n.availableTags.push(l),a(i).remove(),o&&(n=s(n)),n}function s(a){return a.availableTags=a.availableTags.sort(),a.assignedTags=a.assignedTags.sort(),a.originalTags=a.originalTags.sort(),a}function o(e,t,i){var n={tags:e.assignedTags};a.extend(n,t.updateData),a.ajax({type:"POST",url:t.updateURL,cache:!1,data:n,dataType:"json",beforeSend:function(){a("#"+i+"_save").length?a("#"+i+"_save").fadeOut(200,function(){a("#"+i+"_loader").fadeIn(200)}):a("#"+i+"_loader").fadeIn(200)},complete:function(){a("#"+i+"_loader").fadeOut(200,function(){a("#"+i+"_save").length&&a("#"+i+"_save").fadeIn(200)})}})}function l(e,i,n,s){return a(i.assignedTags).each(function(o,l){e.allowEdit?a("<li />").addClass("tagItem").text(l).insertBefore(a(n).parent()):a("<li />").addClass("tagItem").css("cursor","default").text(l).appendTo(a(s)),i.availableTags=t(l,i.availableTags)}),i}function d(e,t){t.debug&&window.console&&window.console.log&&(window.console.log(e),window.console.log(t),window.console.log(a.fn.tagHandler.defaults))}var g={getSerializedTags:function(){var e=[];return a(this).find("li.tagItem").each(function(t,i){e.push(a(i).text())}),e.join(",")},getTags:function(){var e=[];return a(this).find("li.tagItem").each(function(t,i){e.push(a(i).text())}),e},version:function(){return"1.3.0"}};a.fn.tagHandler=function(t){if("object"==typeof t||"undefined"==typeof t){var r=a.extend({},a.fn.tagHandler.defaults,t);return d(a(this),r),this.each(function(){if(!a(this).is("ul"))return!0;var t=this,g=a(t);if(!t.id){var u=new Date;t.id=u.getTime()}g.wrap('<div class="'+r.className+'" />'),g.addClass(r.className+"Container"),r.allowEdit&&g.html('<li class="tagInput"><input class="tagInputField" type="text" /></li>');var c=g.find(".tagInputField"),f=[];return f.availableTags=[],f.originalTags=[],f.assignedTags=[],""!==r.updateURL&&(r.autoUpdate||a("<div />").attr({id:t.id+"_save",title:"Save Tags"}).addClass("tagUpdate").click(function(){o(f,r,t.id)}).appendTo(g.parent()),a("<div />").attr({id:t.id+"_loader",title:"Saving Tags"}).addClass("tagLoader").appendTo(g.parent())),r.autocomplete&&"function"==typeof a.fn.autocomplete&&r.initLoad?a(c).autocomplete({source:f.availableTags,select:function(n,s){var l=a(this);if(!e(a.trim(s.item.value),f.assignedTags)){if(r.maxTags>0&&f.assignedTags.length>=r.maxTags)alert("Maximum tags allowed: "+r.maxTags);else{var d=a.trim(s.item.value),g=1;"function"==typeof r.onAdd&&(g=r.onAdd.call(this,d)),(g||"undefined"==typeof g)&&(f=i(this,d,f,r.sortTags),""!==r.updateURL&&r.autoUpdate&&o(f,r,t.id),a(c).autocomplete("option","source",f.availableTags),"function"==typeof r.afterAdd&&r.afterAdd.call(this,d))}l.focus()}return l.val(""),!1},minLength:r.minChars}):r.autocomplete&&"function"==typeof a.fn.autocomplete&&a(c).autocomplete({source:function(e,t){r.getData[r.queryname]=e.term;a.getJSON(r.getURL,r.getData,function(a,e,i){t(a.availableTags)})},select:function(n,s){var l=a(this);if(!e(a.trim(s.item.value),f.assignedTags)){if(r.maxTags>0&&f.assignedTags.length>=r.maxTags)alert("Maximum tags allowed: "+r.maxTags);else{var d=a.trim(s.item.value),g=1;"function"==typeof r.onAdd&&r.onAdd.call(this,d),(g||"undefined"==typeof g)&&(f=i(this,a.trim(s.item.value),f,r.sortTags),""!==r.updateURL&&r.autoUpdate&&o(f,r,t.id),"function"==typeof r.afterAdd&&r.afterAdd.call(this,d))}l.focus()}return l.val(""),!1},minLength:r.minChars}),""!==r.getURL&&r.initLoad?a.ajax({url:r.getURL,cache:!1,data:r.getData,dataType:"json",success:function(e,i,n){e.availableTags.length&&(f.availableTags=e.availableTags.slice(),f.originalTags=f.availableTags.slice()),r.sortTags&&(f=s(f)),e.assignedTags.length&&(f.assignedTags=e.assignedTags.slice(),r.sortTags&&(f=s(f)),f=l(r,f,c,t)),r.autocomplete&&"function"==typeof a.fn.autocomplete&&r.allowEdit&&a(c).autocomplete("option","source",f.availableTags)},error:function(a,e,t){d(a,e,t),alert(r.msgError)}}):""!==r.getURL?(f.assignedTags=r.assignedTags.slice(),r.sortTags&&(f=s(f)),f=l(r,f,c,t)):(r.availableTags.length&&(f.availableTags=r.availableTags.slice(),f.originalTags=f.availableTags.slice()),r.sortTags&&(f=s(f)),r.assignedTags.length&&(f.assignedTags=r.assignedTags.slice(),r.sortTags&&(f=s(f)),f=l(r,f,c,t)),r.autocomplete&&"function"==typeof a.fn.autocomplete&&r.allowEdit&&r.initLoad&&a(c).autocomplete("option","source",f.availableTags)),r.allowEdit&&(g.delegate("li.tagItem","click",function(){var e=a(this),i=1;"function"==typeof r.onDelete&&(i=r.onDelete.call(this,a.trim(e.text()))),i&&(f=n(e,f,r.sortTags),""!==r.updateURL&&r.autoUpdate&&o(f,r,t.id)),"function"==typeof r.afterDelete&&r.afterDelete.call(this,a.trim(e.text())),r.autocomplete&&"function"==typeof a.fn.autocomplete&&r.initLoad&&a(c).autocomplete("option","source",f.availableTags)}),a(c).keypress(function(n){var s=a(this);if((13===n.which||44===n.which||n.which===r.delimiter.charCodeAt(0))&&(n.preventDefault(),""!==s.val()&&!e(a.trim(s.val()),f.assignedTags))){if(!r.allowAdd&&!e(a.trim(s.val()),f.availableTags))return void alert(r.msgNoNewTag);if(r.maxTags>0&&f.assignedTags.length>=r.maxTags)alert("Maximum tags allowed: "+r.maxTags);else{var l=a.trim(s.val()),d=1;"function"==typeof r.onAdd&&(d=r.onAdd.call(this,l)),(d||"undefined"==typeof d)&&(f=i(this,l,f,r.sorttags),""!==r.updateURL&&r.autoUpdate&&o(f,r,t.id),r.autocomplete&&"function"==typeof a.fn.autocomplete&&r.initload&&a(c).autocomplete("option","source",f.availableTags),"function"==typeof r.afterAdd&&r.afterAdd.call(this,l))}s.val(""),s.focus()}}),a(c).keydown(function(e){var i=a(this);if(8===e.which&&""===i.val()){var s=g.find(".tagItem:last").text();"function"==typeof r.onDelete&&r.onDelete.call(this,a.trim(s)),f=n(g.find(".tagItem:last"),f,r.sortTags),""!==r.updateURL&&r.autoUpdate&&o(f,r,t.id),"function"==typeof r.afterDelete&&r.afterDelete.call(this,a.trim(s)),r.autocomplete&&"function"==typeof a.fn.autocomplete&&r.initLoad&&a(c).autocomplete("option","source",f.availableTags),i.focus()}}),a(c).focus(function(){""===a(c).val()&&r.autocomplete&&"function"==typeof a.fn.autocomplete&&r.initLoad&&a(c).autocomplete("search","")}),g.click(function(){a(c).focus()})),this.getTags=function(){return f.assignedTags},1})}return"string"==typeof t&&g[t]?g[t].apply(this,Array.prototype.slice.call(arguments,1)):void 0},a.fn.tagHandler.defaults={allowEdit:!0,allowAdd:!0,assignedTags:[],autocomplete:!1,autoUpdate:!1,availableTags:[],className:"tagHandler",debug:!1,delimiter:"",getData:{},getURL:"",initLoad:!0,maxTags:0,minChars:0,msgNoNewTag:"You don't have permission to create a new tag.",msgError:"There was an error getting the tag list.",onAdd:{},onDelete:{},afterAdd:{},afterDelete:{},queryname:"q",sortTags:!0,updateData:{},updateURL:""}}(jQuery);
