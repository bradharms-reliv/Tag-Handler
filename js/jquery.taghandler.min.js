!function(a){var t={getSerializedTags:function(){var a=x(this,"tags");return a.assignedTags.join(",")},getTags:function(){var a=x(this,"tags");return a.assignedTags.slice()},getSerializedOptions:function(){var a=x(this,"tags"),t=a.availableTags.concat(a.assignedTags);return t.join(",")},getOptions:function(){var a=x(this,"tags");return a.availableTags.concat(a.assignedTags)},addTag:function(t,e){if(!t)return null;var i=x(this,"opts");if(!i)return null;var n=x(this,"tags");if(!p(this,a.trim(t),e))return n;if(i.maxTags>0&&n.assignedTags.length>=i.maxTags)return alert(i.msgMaxTags+" "+i.maxTags),n;var o=1;return"function"!=typeof i.onAdd||e||(o=i.onAdd.call(this,t)),"undefined"!=typeof o&&o===!1?n:(n.assignedTags.push(t),n.availableTags=a(this).tagHandler("removeOption",t),s(a(this),t),i.sortTags&&(n=T(n)),y(i)&&a(this).find(".tagInputField").autocomplete("option","source",n.availableTags),m(this,"tags",n),""!==i.updateURL&&i.autoUpdate&&!e&&a(this).tagHandler("saveTags"),"function"!=typeof i.afterAdd||e||i.afterAdd.call(this,t),i.maxTags>0&&n.assignedTags.length>=i.maxTags&&a(this).find(".tagInputField").hide(),a(this).tagHandler("refresh"),n)},removeTag:function(t){var e=x(this,"opts");if(!e)return null;var i=x(this,"tags"),n=a(this).find(".tagInputField");return a(this).find('[data-tag="'+t+'"]').remove(),a.each(i.assignedTags,function(a,e){e===t&&i.assignedTags.splice(a,1)}),a(this).tagHandler("addOption",t),e.sortTags&&(i=T(i)),y(e)&&a(this).find(".tagInputField").autocomplete("option","source",i.availableTags),m(this,"tags",i),e.maxTags>0&&i.assignedTags.length<e.maxTags&&n.show(),i},addOption:function(t){var e=x(this,"opts");if(!e)return null;var i=x(this,"tags");return h(this,a.trim(t))?(i.availableTags.push(t),e.sortTags&&(i=T(i)),y(e)&&a(this).find(".tagInputField").autocomplete("option","source",i.availableTags),m(this,"tags",i),i.availableTags):i.availableTags},removeOption:function(t){var e=x(this,"opts");if(!e)return null;var i=x(this,"tags");return a.each(i.availableTags,function(a,e){e===t&&i.availableTags.splice(a,1)}),y(e)&&a(this).find(".tagInputField").autocomplete("option","source",i.availableTags),m(this,"tags",i),i.availableTags},saveTags:function(){var t=x(this,"opts");if(t||t.updateURL){var e=x(this,"generatedId"),i=x(this,"tags"),n=a("#"+e+"_save"),s=a("#"+e+"_loader"),o={tags:i.assignedTags};a.extend(o,t.updateData),a.ajax({type:"POST",url:t.updateURL,cache:!1,data:o,dataType:"json",beforeSend:function(){n.length?a(n).fadeOut(200,function(){a(s).fadeIn(200)}):a(s).fadeIn(200)},complete:function(){a(s).fadeOut(200,function(){n.length&&a(n).fadeIn(200)})}})}},destroy:function(){var t=x(this,"original"),e=a(this).parent();a(e).replaceWith(t)},reload:function(){var t=x(this,"opts"),e=x(this,"original");t&&(a(this).tagHandler("destroy"),a(e).tagHandler(t))},refresh:function(){var t=a(this).tagHandler("getTags");x(this,"opts");a(this).find(".tagItem").remove();var e=this;a.each(t,function(a,t){s(e,t)})},version:function(){return"2.0.0-alpha"}},e=function(t){var e=a.extend({},w(),t);b(a(this),e),a(this).each(function(){if(a(this).is("ul")){m(this,"original",a(this).get(0).cloneNode(!0));var t=[];a(this).find("li").each(function(){e.assignedTags.push(a(this).html()),a(this).remove()}),m(this,"opts",e),m(this,"tags",{availableTags:[],originalTags:[],assignedTags:t}),this.id||(this.id=I()),m(this,"generatedId",this.id),i(this),n(this),o(this),r(this),g(this),"function"==typeof e.afterLoad&&!e.getURL&&e.initLoad&&l(this)}})},i=function(t){var e=x(t,"opts"),i=a(t);i.wrap('<div class="'+e.className+'" />'),i.addClass(e.className+"Container");var n=a('<li class="tagInput"></li>');n.append('<input class="tagInputField" type="text" />'),e.allowEdit&&i.append(n)},n=function(t){var e=x(t,"opts");""!==e.updateURL&&(e.autoUpdate||a("<div></div>").attr({id:t.id+"_save",title:"Save Tags"}).addClass("tagUpdate").click(function(){a(t).tagHandler("saveTags")}).appendTo(a(t).parent()),a("<div />").attr({id:t.id+"_loader",title:"Saving Tags"}).addClass("tagLoader").appendTo(a(t).parent()))},s=function(t,e){var i=a(t).find(".tagInputField"),n=x(t,"opts"),s=a('<li data-tag="'+e+'"></li>');a(s).addClass("tagItem");var o=a("<span>"+e+"</span>");n.jqueryTheme&&(a(s).addClass("ui-menu-item").addClass("ui-widget").addClass("ui-state-default").addClass("ui-button-text-only").addClass("ui-corner-all").addClass("ui-widget-content").addClass("jqueryUiTagItem").removeClass("tagItem"),a(o).addClass("ui-button-text")),a(s).append(o),a(s).insertBefore(a(i).parent())},o=function(t){var e=x(t,"opts");if(e&&e.autocomplete&&"function"==typeof a.fn.autocomplete){var i=x(t,"tags"),n=null;n=e.initLoad?i.availableTags:e.getURL?function(t,i){e.initLoad||(e.getData[e.queryname]=t.term),a.ajax({url:e.getURL,cache:!1,data:e.getData,dataType:"json",success:function(a){i(a.availableTags)},error:function(a,t,i){throw b(a,{text:t,error:i}),new Error(e.msgError)}})}:[];var s=a(t).find(".tagInputField");a(s).autocomplete({source:n,select:function(e,n){var s=a(this),o=a.trim(n.item.value);return i=a(t).tagHandler("addTag",o),s.focus(),s.val(""),!1},minLength:e.minChars})}},r=function(t){var e=x(t,"opts");if(e){x(t,"tags");""!==e.getURL&&e.initLoad?a.ajax({url:e.getURL,cache:!1,data:e.getData,dataType:"json",success:function(a){f(t,a),l(t)},error:function(a,t,i){throw b(a,{text:t,error:i}),new Error(e.msgError)}}):f(t,e)}},l=function(a){var t=x(a,"opts");t&&"function"==typeof t.afterLoad&&t.afterLoad.call(a)},g=function(t){var e=x(t,"opts");if(e){var i=x(t,"tags"),n=a(t).find(".tagInputField");e.allowEdit&&(a(n).keypress(a(t),u),a(n).keydown(a(t),c),a(t).click(function(){a(n).focus(),a(n).trigger("focus")}),a(n).focus(function(){""===a(n).val()&&e.autocomplete&&"function"==typeof a.fn.autocomplete&&i.availableTags.length>0&&a(n).autocomplete("search","")}),a(t).delegate("li.tagItem, li.jqueryUiTagItem","click",a(t),d))}},d=function(t){var e=t.data,i=x(e,"opts");if(i){var n=(x(e,"tags"),a(this)),s=1;"function"==typeof i.onDelete&&(s=i.onDelete.call(this,a.trim(n.text()))),(s||"undefined"==typeof s)&&(a(e).tagHandler("removeTag",n.text()),""!==i.updateURL&&i.autoUpdate&&a(e).tagHandler("saveTags")),"function"==typeof i.afterDelete&&i.afterDelete.call(this,a.trim(n.text()))}},u=function(t){var e=t.data,i=x(e,"opts");if(i){var n=x(e,"tags"),s=t.keyCode||t.which,o=a(this);if(13===s||44===s||9===s||s===i.delimiter.charCodeAt(0)){if(t.preventDefault(),t.stopImmediatePropagation(),!i.allowAdd)return void alert(i.msgNoNewTag);if(i.maxTags>0&&n.assignedTags.length>=i.maxTags)alert(i.msgMaxTags+" "+i.maxTags);else{var r=a.trim(o.val());n=a(e).tagHandler("addTag",r)}o.val(""),o.focus()}}},c=function(t){var e=t.data,i=x(e,"opts");if(i){var n=x(e,"tags"),s=t.keyCode||t.which,o=a(this);if(9===s&&(t.preventDefault(),t.stopImmediatePropagation()),8===t.which&&""===o.val()){var r=n.assignedTags.slice(-1)[0],l=1;"function"==typeof i.onDelete&&(l=i.onDelete.call(this,a.trim(r))),(l||"undefined"==typeof l)&&(a(e).tagHandler("removeTag",r),""!==i.updateURL&&i.autoUpdate&&a(e).tagHandler("saveTags")),"function"==typeof i.afterDelete&&i.afterDelete.call(this,a.trim(r)),o.focus()}}},f=function(t,e){a(e.availableTags).each(function(e,i){a(t).tagHandler("addOption",i)}),a(e.assignedTags).each(function(e,i){a(t).tagHandler("addTag",i,!0)})},p=function(a,t,e){var i=x(a,"opts");if(!i)return!1;var n=x(a,"tags");if(v(t,n,"assignedTags"))return!1;var s=!0;return"function"!=typeof i.onIsValid||e||(s=i.onIsValid.call(this,t)),s},h=function(a,t){var e=x(a,"opts");if(!e)return!1;var i=x(a,"tags");return v(t,i,"assignedTags")?!1:v(t,i,"availableTags")?!1:!0},v=function(a,t,e){var i=!1;return jQuery.each(t[e],function(t,e){return e===a?(i=!0,!1):!0}),i},T=function(a){return a.availableTags=a.availableTags.sort(),a.assignedTags=a.assignedTags.sort(),a.originalTags=a.originalTags.sort(),a},m=function(t,e,i){var n=a(t).data("tagHandlerState");n||(n={}),n[e]=i,a(t).data("tagHandlerState",n)},x=function(t,e){var i=a(t).data("tagHandlerState");return i&&void 0!=i[e]?i[e]:null},y=function(t){return t.autocomplete&&"function"==typeof a.fn.autocomplete&&t.allowEdit&&t.initLoad?!0:!1},w=function(){return{allowEdit:!0,allowAdd:!0,assignedTags:[],autocomplete:!1,autoUpdate:!1,availableTags:[],className:"tagHandler",debug:!1,delimiter:"",getData:{},getURL:"",initLoad:!0,maxTags:0,minChars:0,msgNoNewTag:"You don't have permission to create a new tag.",msgError:"There was an error getting the tag list.",msgMaxTags:"Maximum tags allowed:",onAdd:{},onDelete:{},onIsValid:{},afterAdd:{},afterDelete:{},queryname:"q",sortTags:!0,updateData:{},updateURL:"",jqueryTheme:!1}},b=function(a,t){t.debug&&window.console&&window.console.log&&(window.console.log(a),window.console.log(t),window.console.log(w()))},I=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var t=16*Math.random()|0,e="x"==a?t:3&t|8;return e.toString(16)})};jQuery.fn.tagHandler=function(a){return"string"==typeof a&&t[a]?t[a].apply(this,Array.prototype.slice.call(arguments,1)):e.apply(this,arguments)}}(jQuery);
